<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>離線行事曆＋農民曆＋事件＋待辦</title>
  <style>
    :root{
      /* 亮色主題（預設） */
      --bg:#f6f8fc; --card:#ffffff; --muted:#5a6b7e; --text:#0b1220; --accent:#2563eb;
      --ok:#1f8a4c; --bad:#c0352b; --warn:#b7791f; --chip:#eef2ff; --chip-border:#c7d2fe;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0f14; --card:#121821; --muted:#9fb0c3; --text:#e6edf6; --accent:#7cc4ff;
        --ok:#3ddc84; --bad:#ff6b6b; --warn:#ffd166; --chip:#1b2635; --chip-border:#2f4764;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:System-ui, -apple-system, Roboto, Noto Sans TC, Segoe UI, Arial}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.5px}
    .bar{display:flex;gap:6px;align-items:center}
    button{background:var(--card);border:1px solid var(--chip-border);color:var(--text);padding:8px 10px;border-radius:12px}
    button:active{transform:translateY(1px)}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{opacity:.7;text-align:center;font-size:12px}
    .cell{background:var(--card);border:1px solid var(--chip-border);border-radius:12px;min-height:68px;padding:6px;display:flex;flex-direction:column;gap:4px;position:relative}
    .cell .g{font-weight:700}
    .cell .l{font-size:11px;opacity:.8}
    .cell.other{opacity:.45}
    .cell.selected{outline:2px solid var(--accent)}
    .dotbar{position:absolute;bottom:6px;left:6px;display:flex;gap:4px}
    .dot{width:8px;height:8px;border-radius:50%;background:#3b82f6;opacity:1;box-shadow:0 0 2px #000}
    .dot.todo{background:#22c55e}
    .panel{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media(min-width:1000px){.panel{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--chip-border);border-radius:16px;padding:12px}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--chip-border);margin:2px;font-size:12px}
    .tag.ok{border-color:#15803d;color:var(--ok)}
    .tag.bad{border-color:#b91c1c;color:var(--bad)}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--chip-border);background:#ffffff;color:var(--text)}
    @media (prefers-color-scheme: dark){ input,textarea,select{border:1px solid #203146;background:#ffffff;color:#000000} }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:8px;align-items:flex-start}
    .item .t{flex:1}
    .item .x{opacity:.8}
    .hint{font-size:12px;color:var(--muted)}
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    a{color:var(--accent)}
    .pill{font-size:12px;padding:2px 10px;border:1px solid var(--chip-border);border-radius:999px;color:var(--text);background:var(--chip);display:inline-flex;align-items:center;gap:8px;font-weight:600;box-shadow:0 0 0 1px var(--chip-border) inset}
    .icon{width:14px;height:14px;display:inline-block}
    .icon svg{display:block}
    label.small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <button id="prev">←</button>
        <button id="today">今天</button>
        <button id="next">→</button>
      </div>
      <h1 id="title">2025 年 8 月</h1>
      <div class="bar">
        <button id="exportBtn">匯出資料</button>
        <button id="importBtn">匯入資料</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <div class="grid" id="dow"></div>
    <div class="grid" id="cal"></div>

    <section class="panel">
      <div class="card">
        <h3 style="margin:0 0 8px">農民曆 <span id="selDate" class="muted"></span></h3>
        <div id="huangli">
          <div class="muted" id="huangliHint">若偵測到 <code>lunar-javascript</code> 會顯示：<b>每日良辰（無忌）</b> 時間區段（支援簡→繁）。</div>
          <div id="yi"></div>
          <div id="ji" style="margin-top:6px"></div>
          <div id="times" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 8px 8px 0;display:flex;align-items:center;gap:8px">當日行程
          <span class="pill"><span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="14" height="14" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="9"/>
              <path d="M12 7v5l3 3"/>
            </svg>
          </span>時間清晰顯示</span>
        </h3>
        <form id="eventForm" onsubmit="return false;">
          <div class="row">
            <input id="evTitle" placeholder="標題（必填）" />
            <input id="evLocation" placeholder="地點（選填）" />
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="small">開始日期</label>
              <input id="evStartDate" type="date" />
            </div>
            <div>
              <label class="small">結束日期（可同日或跨日）</label>
              <input id="evEndDate" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="small">開始時間</label>
              <input id="evStartTime" type="time" />
            </div>
            <div>
              <label class="small">結束時間</label>
              <input id="evEndTime" type="time" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="small">重複</label>
              <select id="evRepeat">
                <option value="none">不重複</option>
                <option value="DAILY">每天</option>
                <option value="WEEKLY">每週</option>
                <option value="MONTHLY">每月</option>
              </select>
            </div>
            <div>
              <label class="small">間隔（每隔 N 天／週／月）</label>
              <input id="evInterval" type="number" min="1" step="1" value="1" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="small">重複結束（Until，可空白）</label>
              <input id="evUntil" type="date" />
            </div>
            <div>
              <label class="small">&nbsp;</label>
              <div class="muted">例：每 <b>2</b> 週、每 <b>3</b> 月等</div>
            </div>
          </div>
          <textarea id="evNote" placeholder="備註（選填）" style="margin-top:8px"></textarea>
          <div class="bar" style="margin-top:8px;justify-content:flex-end">
            <button id="addEvent">新增行程</button>
          </div>
        </form>
        <div id="eventList" class="list"></div>
        <br><br><br><div class="hint">行程使用 <b>IndexedDB</b> 儲存。跨日、重複（每天/每週/每月，含「每隔 N」）皆可；列表顯示的是「當日落在的實際發生」。</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">待辦事項（依所選日期）</h3>
        <form id="todoForm" class="item" onsubmit="return false;">
          <input id="todoInput" placeholder="新增待辦…（Enter 送出）" />
          <button id="addTodo">新增</button>
        </form>
        <div id="todoList" class="list"></div>
        <br><br><br><div class="hint">待辦亦存於 <b>IndexedDB</b>。</div>
      </div>
    </section>
  </div>

  <!-- OpenCC（瀏覽器）— 你提供的 UMD 版本：簡體→繁體 -->
  <script src="cn2t.js"></script>
  <script>
    (function(){
      try{
        if (typeof window.cn2t === 'function') {
          window.customS2T = s => window.cn2t(String(s||''));
        } else if (window.OpenCC && typeof OpenCC.Converter === 'function') {
          const conv = OpenCC.Converter({ from:'cn', to:'tw' });
          window.customS2T = s => conv(String(s||''));
        }
      }catch(e){}
    })();
  </script>

  <!-- （選用）6tail lunar：若加入則顯示農曆、宜忌、時辰吉凶 -->
  <script src="lunar.js"></script>

  <script>
    // ========== 實用小函式 ==========
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls, txt) => { const n=document.createElement(tag); if(cls) n.className=cls; if(txt!=null) n.textContent=txt; return n; };
    const pad = n => String(n).padStart(2,'0');
    const fmtYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    let current = new Date();
    let selected = new Date();

    // ========== IndexedDB ==========
    const DB_NAME = 'offline-almanac';
    const DB_VERSION = 3; // schema v3 (adds repeat.interval)
    const STORES = { events: 'events', todos: 'todos' };

    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORES.events)){
            const s = db.createObjectStore(STORES.events, { keyPath: 'id' });
            s.createIndex('byStart', 'startDate', { unique: false });
          } else {
            const s = req.transaction.objectStore(STORES.events);
            if(!s.indexNames.contains('byStart')) s.createIndex('byStart','startDate',{unique:false});
          }
          if(!db.objectStoreNames.contains(STORES.todos)){
            const s = db.createObjectStore(STORES.todos, { keyPath: 'id' });
            s.createIndex('byDate', 'date', { unique: false });
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
    }

    function tx(db, store, mode='readonly'){
      return db.transaction(store, mode).objectStore(store);
    }

    async function addEventRecord(rec){ const db = await openDB(); return new Promise(r=>{ tx(db, STORES.events,'readwrite').add(rec).onsuccess=()=>r(); }); }
    async function listAllEvents(){ const db=await openDB(); return new Promise(r=>{ const s=tx(db, STORES.events); const a=[]; s.openCursor().onsuccess=(e)=>{ const c=e.target.result; if(c){ a.push(c.value); c.continue(); } else r(a); }; }); }
    async function deleteEvent(id){ const db=await openDB(); return new Promise(r=>{ tx(db, STORES.events,'readwrite').delete(id).onsuccess=()=>r(); }); }

    async function listTodosByDate(ymd){ const db=await openDB(); const idx=tx(db, STORES.todos).index('byDate'); return new Promise(r=>{ const a=[]; idx.openCursor(IDBKeyRange.only(ymd)).onsuccess=(e)=>{ const c=e.target.result; if(c){ a.push(c.value); c.continue(); } else r(a); }; }); }
    async function addTodoRecord(rec){ const db=await openDB(); return new Promise(r=>{ tx(db, STORES.todos,'readwrite').add(rec).onsuccess=()=>r(); }); }
    async function updateTodo(rec){ const db=await openDB(); return new Promise(r=>{ tx(db, STORES.todos,'readwrite').put(rec).onsuccess=()=>r(); }); }
    async function deleteTodo(id){ const db=await openDB(); return new Promise(r=>{ tx(db, STORES.todos,'readwrite').delete(id).onsuccess=()=>r(); }); }

    async function exportAll(){
      const db = await openDB();
      const dump = { events: [], todos: [] };
      const readStore = (name) => new Promise((resolve)=>{
        const s = tx(db, name); const req = s.openCursor(); const arr=[]; req.onsuccess=(e)=>{ const c=e.target.result; if(c){ arr.push(c.value); c.continue(); } else resolve(arr); };
      });
      dump.events = await readStore(STORES.events);
      dump.todos  = await readStore(STORES.todos);
      return dump;
    }

    async function importAll(json){
      const db = await openDB();
      await new Promise((resolve)=>{ tx(db, STORES.events,'readwrite').clear().onsuccess=()=>resolve(); });
      await new Promise((resolve)=>{ tx(db, STORES.todos ,'readwrite').clear().onsuccess=()=>resolve(); });
      await new Promise((resolve)=>{ const s=tx(db, STORES.events,'readwrite'); (json.events||[]).forEach(r=>s.add(r)); resolve(); });
      await new Promise((resolve)=>{ const s=tx(db, STORES.todos ,'readwrite'); (json.todos ||[]).forEach(r=>s.add(r)); resolve(); });
    }

    // ========== 曜日與月曆 ==========
    const DOW = ['日','一','二','三','四','五','六'];
    function renderDOW(){ const box=$('#dow'); box.innerHTML=''; DOW.forEach(w=> box.appendChild(el('div','dow',w)) ); }
    function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1)}
    function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0)}

    async function renderCalendar(){
      const box = $('#cal'); box.innerHTML='';
      const s = startOfMonth(current); const e = endOfMonth(current);
      const startIdx = s.getDay(); const days = e.getDate();
      const prevEnd = new Date(current.getFullYear(), current.getMonth(), 0).getDate();
      for(let i=startIdx-1;i>=0;i--){ const d=new Date(current.getFullYear(), current.getMonth()-1, prevEnd-i); box.appendChild(await cell(d,true)); }
      for(let i=1;i<=days;i++){ const d=new Date(current.getFullYear(), current.getMonth(), i); box.appendChild(await cell(d,false)); }
      const total = box.children.length;
      for(let i=1; i<= 42-total; i++){ const d=new Date(current.getFullYear(), current.getMonth()+1, i); box.appendChild(await cell(d,true)); }
      $('#title').textContent = `${current.getFullYear()} 年 ${current.getMonth()+1} 月`;
      updateSelection(selected);
    }

    async function cell(d, other){
      const div = el('div','cell'+(other?' other':''));
      div.dataset.date = fmtYMD(d);
      const g = el('div','g', d.getDate());
      const l = el('div','l', lunarLabel(d));
      const dotbar = el('div','dotbar');
      const ymd = fmtYMD(d);
      const [evsAll, tds] = await Promise.all([listAllEvents(), listTodosByDate(ymd)]);
      const hasEvent = evsAll.some(ev=> occursOnDate(ev, d));
      if(hasEvent) dotbar.appendChild(el('div','dot'));
      if(tds.length) dotbar.appendChild(el('div','dot todo'));
      div.append(g,l,dotbar);
      div.addEventListener('click', async () => { selected = new Date(d); updateSelection(selected); });
      return div;
    }

    async function updateSelection(d){
      document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
      const hit = document.querySelector(`.cell[data-date="${fmtYMD(d)}"]`);
      if(hit) hit.classList.add('selected');
      $('#selDate').textContent = `— ${fmtYMD(d)}`;
      renderHuangli(d);
      await renderEvents(d);
      await renderTodos(d);
    }

    // ========== 農民曆（6tail；支援簡→繁，良辰無忌） ==========
    const S2T = (function(){
      if (typeof window.customS2T === 'function') return (s='')=> window.customS2T(s);
      const map = {"农":"農","历":"曆","气":"氣","阴":"陰","阳":"陽","岁":"歲","台":"臺","冲":"衝","杀":"殺","龙":"龍","凤":"鳳","云":"雲","雲":"雲"};
      return (s='')=> s.replace(/[\u4e00-\u9fff]/g, ch => map[ch] || ch);
    })();

    const ZHI_RANGES = {
      '子':'23:00–01:00','丑':'01:00–03:00','寅':'03:00–05:00','卯':'05:00–07:00',
      '辰':'07:00–09:00','巳':'09:00–11:00','午':'11:00–13:00','未':'13:00–15:00',
      '申':'15:00–17:00','酉':'17:00–19:00','戌':'19:00–21:00','亥':'21:00–23:00'
    };
    const ZHI_SET = new Set('子丑寅卯辰巳午未申酉戌亥'.split(''));
    function zhiToRange(z){
      const key = (z==='醜') ? '丑' : z; // 容錯：如果被 OpenCC 轉成「醜」，仍能對到
      return ZHI_RANGES[key] || '';
    }

    function yjIsEmpty(v){
      if (Array.isArray(v)){
        if (v.length===0) return true;
        const txt = v.join('').trim();
        return txt==='' || txt==='无' || txt==='無';
      }
      const txt = String(v||'').trim();
      return txt==='' || txt==='无' || txt==='無';
    }

    function lunarLabel(d){
      try{
        if (window.Solar && Solar.fromYmd){
          const s = Solar.fromYmd(d.getFullYear(), d.getMonth()+1, d.getDate());
          const l = s.getLunar();
          return S2T(`${l.getMonthInChinese()}月${l.getDayInChinese()}`);
        }
      }catch(e){}
      return '';
    }

    function renderHuangli(d){
      const hint = $('#huangliHint'); const yi = $('#yi'); const ji = $('#ji'); const times = $('#times');
      yi.innerHTML = ji.innerHTML = times.innerHTML = '';
      try{
        if (window.Solar && Solar.fromYmd){
          hint.style.display='none';
          const s = Solar.fromYmd(d.getFullYear(), d.getMonth()+1, d.getDate());
          const l = s.getLunar();
          const arr = l.getTimes ? l.getTimes() : [];
          const goodSlots = arr.filter(t => {
            const jiArr = t.getJi ? t.getJi() : [];
            // 有些實作在「無」時會回傳 ['无']，視為沒有忌
            return yjIsEmpty(jiArr);
          }).map(t => {
            const raw = t.getZhi ? t.getZhi() : '';
            const name = (typeof ZHI_SET!=='undefined' && ZHI_SET.has(raw)) ? raw : S2T(raw);
            const range = zhiToRange(name);
            return `<span class="tag ok">${name}${range?`（${range}）`:''}</span>`;
          });
          times.innerHTML = goodSlots.length
            ? `<div>良辰（無忌）：</div>` + goodSlots.join('')
            : `<div class="muted">今日無明顯「無忌良辰」</div>`;
        } else { hint.style.display='block'; }
      }catch(e){ hint.style.display='block'; }
    }

    // ========== 行程（跨日／重複＋間隔） ==========
    function occursOnDate(ev, date){
      const ymd = fmtYMD(date);
      const start = ev.startDate || ev.date;
      const end   = ev.endDate   || ev.startDate || ev.date;
      const durDays = dayDiffInclusive(start, end);
      const freq = ev.repeat && ev.repeat.freq || 'none';
      const interval = Math.max(1, ev.repeat && ev.repeat.interval ? Number(ev.repeat.interval) : 1);
      if(freq==='none') return isDateInWindow(ymd, start, end);
      const until = ev.repeat.until || null;
      let cur = start;
      let safety = 0;
      while(true){
        if(until && cur > until) return false;
        const curEnd = addDays(cur, durDays-1);
        if(isDateInWindow(ymd, cur, curEnd)) return true;
        cur = advance(cur, freq, interval);
        if(cur > ymd && !until) return false;
        if(++safety>2000) return false; // 保守的防呆
      }
    }
    function isDateInWindow(target, start, end){ return (start <= target && target <= end); }
    function addDays(ymd, days){ const d=parseYMD(ymd); d.setDate(d.getDate()+days); return fmtYMD(d); }
    function advance(ymd, freq, interval){ const d=parseYMD(ymd); if(freq==='DAILY') d.setDate(d.getDate()+interval); else if(freq==='WEEKLY') d.setDate(d.getDate()+7*interval); else if(freq==='MONTHLY') d.setMonth(d.getMonth()+interval); return fmtYMD(d); }
    function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
    function dayDiffInclusive(a,b){ const da=parseYMD(a), db=parseYMD(b); const t=Math.round((db-da)/(24*3600*1000)); return t+1; }

    async function renderEvents(d){
      const box = $('#eventList'); box.innerHTML='';
      const all = await listAllEvents();
      const today = all.filter(ev=> occursOnDate(ev, d));
      if(!today.length){ box.appendChild(el('div','muted','（尚無行程）')); return; }
      today.sort((a,b)=> (a.startTime||'99:99').localeCompare(b.startTime||'99:99'));
      today.forEach(it=>{
        const row = el('div','item');
        const t = el('div','t');
        const durText = displayDuration(it);
        const line1 = el('div'); line1.innerHTML = `<span class="pill">${durText}</span> <b>${it.title}</b>` + (it.location? ` · ${it.location}`: '');
        const line2 = it.note? el('div','muted', it.note): null;
        const line3 = (it.repeat && it.repeat.freq!=='none')? el('div','muted', `重複：${repeatLabel(it.repeat)}`): null;
        t.append(line1); if(line2) t.append(line2); if(line3) t.append(line3);
        const del = el('button','x','刪除');
        del.addEventListener('click', async ()=>{ await deleteEvent(it.id); renderEvents(selected); renderCalendar(); });
        row.append(t,del); box.appendChild(row);
      });
    }

    function displayDuration(ev){
      const sameDay = ev.startDate === ev.endDate;
      const st = `${ev.startDate || ''} ${ev.startTime || ''}`.trim();
      const et = `${ev.endDate   || ''} ${ev.endTime   || ''}`.trim();
      if(sameDay){ return `${ev.startTime||'—'}~${ev.endTime||'—'}`; }
      return `${st} ~ ${et}`;
    }
    function repeatLabel(r){
      const base = { DAILY:'每天', WEEKLY:'每週', MONTHLY:'每月' }[r.freq] || '不重複';
      const intv = r.interval && Number(r.interval)>1 ? `，每 ${r.interval}` : '';
      const unit = r.freq==='DAILY'? '天' : (r.freq==='WEEKLY'? '週' : (r.freq==='MONTHLY'? '月' : ''));
      const until = r.until ? `，至 ${r.until}` : '';
      return base + (intv? intv+unit : '') + until;
    }

    function getVal(sel){ return (document.querySelector(sel).value||'').trim(); }
    $('#addEvent').addEventListener('click', async ()=>{
      const title = getVal('#evTitle'); if(!title){ alert('請輸入標題'); return; }
      const sd = getVal('#evStartDate') || fmtYMD(selected);
      const ed = getVal('#evEndDate')   || sd;
      const st = getVal('#evStartTime');
      const et = getVal('#evEndTime');
      const rep = getVal('#evRepeat');
      const interval = Math.max(1, Number(getVal('#evInterval')||'1'));
      const until = getVal('#evUntil');
      const rec = { id:'ev-'+Date.now()+Math.random().toString(16).slice(2), title, location:getVal('#evLocation'), startDate:sd, endDate:ed, startTime:st, endTime:et, note:getVal('#evNote'), repeat:{ freq:rep, interval, until: until || null } };
      await addEventRecord(rec);
      ['#evTitle','#evLocation','#evStartDate','#evEndDate','#evStartTime','#evEndTime','#evNote','#evUntil','#evInterval'].forEach(s=>{ const x=$(s); if(x) x.value=''; });
      $('#evRepeat').value='none';
      await renderEvents(selected); await renderCalendar();
    });

    // ========== 待辦 ==========
    async function renderTodos(d){
      const box = $('#todoList'); box.innerHTML='';
      const ymd = fmtYMD(d);
      const arr = await listTodosByDate(ymd);
      if(!arr.length){ box.appendChild(el('div','muted','（尚無待辦）')); return; }
      arr.sort((a,b)=> Number(a.done)-Number(b.done) || a.ts-b.ts);
      arr.forEach(it=>{
        const row = el('div','item');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.done;
        const t = el('div','t', it.text);
        if(it.done) t.style.textDecoration='line-through';
        const del = el('button','x','刪除');
        cb.addEventListener('change', async ()=>{ it.done=cb.checked; await updateTodo(it); renderTodos(selected); renderCalendar(); });
        del.addEventListener('click', async ()=>{ await deleteTodo(it.id); renderTodos(selected); renderCalendar(); });
        row.append(cb,t,del); box.appendChild(row);
      });
    }

    function addTodoNow(text){ if(!text) return; const rec={ id:'td-'+Date.now()+Math.random().toString(16).slice(2), date: fmtYMD(selected), text, done:false, ts:Date.now() }; addTodoRecord(rec).then(()=>{ renderTodos(selected); renderCalendar(); }); }
    $('#addTodo').addEventListener('click', ()=>{ const v = $('#todoInput').value.trim(); if(!v) return; addTodoNow(v); $('#todoInput').value=''; });
    $('#todoInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addTodo').click(); }});

    // ========== 匯入／匯出 ==========
    $('#exportBtn').addEventListener('click', async ()=>{
      const data = await exportAll();
      const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='almanac-backup.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = async () => { try{ const json=JSON.parse(r.result); await importAll(json); await renderCalendar(); await updateSelection(selected);}catch(err){ alert('匯入失敗'); } };
      r.readAsText(f);
    });

    // ========== 導覽 ==========
    $('#prev').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); renderCalendar(); });
    $('#next').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); renderCalendar(); });
    $('#today').addEventListener('click', ()=>{ current = new Date(); selected=new Date(); renderCalendar(); });

    // ========== 啟動 ==========
    renderDOW();
    renderCalendar();
  </script>
</body>
</html>
